name: .NET Unit & Coverage Tests

on:
  push:
    branches:
      - '**'

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Install Coverlet global tool
        run: dotnet tool install --global coverlet.console

      - name: Restore dependencies
        run: dotnet restore Stella.Ergosfare.sln

      - name: Run unit tests with coverage
        run: |
          mkdir -p coverage
          dotnet test Stella.Ergosfare.sln \
            --settings coverlet.runsettings \
            --no-build \
            /p:CollectCoverage=true \
            /p:CoverletOutput=./coverage/coverage.json \
            /p:CoverletOutputFormat=cobertura \
            /p:MergeWith=./coverage/coverage.json \
            /p:UseAppHost=false \
            /p:VSTestLogger=

      - name: Check coverage threshold
        run: |
          TOTAL_COVERAGE=$(dotnet tool run coverlet ./coverage/coverage.json --threshold-type line --threshold 90 --fail-under 90 || echo 0)
          echo "Total coverage: $TOTAL_COVERAGE"
        shell: bash
