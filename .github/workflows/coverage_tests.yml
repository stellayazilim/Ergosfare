name: .NET Unit & Coverage Tests

on:
  push:
    branches:
      - '**'
    paths-ignore:
      - 'coverage.svg'

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Install Coverlet global tool
        run: dotnet tool install --global coverlet.console

      - name: Restore dependencies
        run: dotnet restore Stella.Ergosfare.sln

      - name: Run tests with coverage
        run: |
          mkdir -p coverage
          dotnet test Stella.Ergosfare.sln \
            --settings coverlet.runsettings \
            /p:CollectCoverage=true \
            /p:CoverletOutput=./coverage/coverage.cobertura.xml \
            /p:CoverletOutputFormat=cobertura \
            /p:MergeWith=./coverage/coverage.cobertura.xml \
            /p:UseAppHost=false \
            /p:VSTestLogger=

      - name: Check coverage threshold
        run: |
          if [ ! -f coverage/coverage.cobertura.xml ]; then
            echo "Coverage file not found!"
            exit 1
          fi

          COVERAGE=$(grep -oP '(?<=line-rate=")[0-9.]+' coverage/coverage.cobertura.xml)
          COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc)
          echo "Total coverage: $COVERAGE_PERCENT%"
          if (( $(echo "$COVERAGE_PERCENT < 90" | bc -l) )); then
            echo "Coverage $COVERAGE_PERCENT% is below 90%"
            exit 1
          fi

      - name: Generate coverage badge
        uses: action-badges/cobertura-coverage-xml-badges@0.3.1
        with:
          file-name: coverage.svg
          badge-branch: ${{ github.ref_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          coverage-file-name: ./coverage/coverage.cobertura.xml

      - name: Commit coverage badge
        run: |
          # Skip if no changes
          if git diff --quiet coverage.svg; then
            echo "No badge changes detected, skipping commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add coverage.svg
          git commit -m "Update coverage badge"
          git push