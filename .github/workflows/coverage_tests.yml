name: .NET Unit & Coverage Tests

on:
  push:
    branches:
      - '**'
    paths-ignore:
      - '.badges/chore_workflows/coverage.svg'

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Install Coverlet global tool
        run: dotnet tool install --global coverlet.console

      - name: Restore dependencies
        run: dotnet restore Stella.Ergosfare.sln

      - name: Run Unit & Coverage Tests
        shell: bash
        run: |
          mkdir -p coverage
          dotnet test Stella.Ergosfare.sln \
            --settings coverlet.runsettings \
            /p:CollectCoverage=true \
            "/p:MergeWith=../../coverage/coverlet.cobertura.xml" \
            "/p:CoverletOutputFormat=cobertura" \
            "/p:CoverletOutput=../../coverage/coverlet.cobertura.xml" \
            --logger "trx;LogFileName=TestResults.trx"

      - name: Install Report Generator
        run:  dotnet tool install --global dotnet-reportgenerator-globaltool
      
      - name: Merge coverage reports
        run:  reportgenerator -reports:./**/coverage.cobertura.xml -targetdir:./coverage -reporttypes:Cobertura
        shell: bash

      - name: Fail if coverage < 90%
        shell: bash
        run: |
          COVERAGE=$(grep -oP '(?<=line-rate=")[0-9.]+' coverage/coverage.cobertura.xml)
          echo "Total line coverage: $COVERAGE"
          COVERAGE_INT=$(echo "$COVERAGE * 100 / 1" | bc)
          if [ "$COVERAGE_INT" -lt 90 ]; then
            echo "Coverage $COVERAGE% is below 90%!"
            exit 1
          fi
        
      - uses: action-badges/create-orphan-branch@0.1.1
          with:
            branch-name: badges
      - name: Generate coverage badge
        uses: action-badges/cobertura-coverage-xml-badges@0.3.1
        with:
          file-name: coverage.svg
          badge-branch: badge
          github-token: ${{ secrets.GITHUB_TOKEN }}
          coverage-file-name: ./coverage/coverage.cobertura.xml
      - uses: action-badges/create-orphan-branch@0.1.1
          with:
            branch-name: badges
