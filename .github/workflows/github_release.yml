name: GitHubPackagesRelease

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        default: 'main'
      tag:
        description: 'Version tag (must start with v)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    environment: publish
    strategy:
      matrix:
        dotnet-version: [ 9.0.x, 10.0.x ]   # .NET 9 ve 10
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Resolve branch
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_ENV
          else
            echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          fi
      
      - uses: actions/checkout@v3
        with:
          ref: ${{ env.branch }}

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Set version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi

          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using version: $VERSION"

      - name: Validate release type
        run: |
          if [[ "${{ env.branch }}" == "main" ]] && [[ "$VERSION" == *-* ]]; then
            echo "❌ RC tag from main branch is not allowed" && exit 1
          fi
          if [[ "${{ env.branch }}" =~ rc[0-9]+ ]] && [[ "$VERSION" != *-* ]]; then
            echo "❌ Stable tag from RC branch is not allowed" && exit 1
          fi
          echo "✔ GitHub release validation passed"

      - name: Restore & Build
        run: |
          dotnet restore ./Stella.Ergosfare.slnx
          dotnet build ./Stella.Ergosfare.slnx -c Release

      - name: Pack all GitHub packages
        run: |
          projects=(
            ./src/Stella.Ergosfare/Stella.Ergosfare.csproj
            ./src/Stella.Ergosfare.Contracts/Stella.Ergosfare.Contracts.csproj
            ./src/Stella.Ergosfare.Core/Stella.Ergosfare.Core.csproj
            ./src/Stella.Ergosfare.Core.Abstractions/Stella.Ergosfare.Core.Abstractions.csproj
            ./src/Stella.Ergosfare.Core.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Core.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Stella.Ergosfare.Queries/Stella.Ergosfare.Queries.csproj
            ./src/Stella.Ergosfare.Queries.Abstractions/Stella.Ergosfare.Queries.Abstractions.csproj
            ./src/Stella.Ergosfare.Queries.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Queries.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Stella.Ergosfare.Commands/Stella.Ergosfare.Commands.csproj
            ./src/Stella.Ergosfare.Commands.Abstractions/Stella.Ergosfare.Commands.Abstractions.csproj
            ./src/Stella.Ergosfare.Commands.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Commands.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Stella.Ergosfare.Events/Stella.Ergosfare.Events.csproj
            ./src/Stella.Ergosfare.Events.Abstractions/Stella.Ergosfare.Events.Abstractions.csproj
            ./src/Stella.Ergosfare.Events.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Events.Extensions.MicrosoftDependencyInjection.csproj
          )

          for proj in "${projects[@]}"; do
            echo "Packing $proj"
            dotnet pack "$proj" -c Release -o ./nupkg-github /p:Version=${{ env.VERSION }} /p:IncludeSymbols=true /p:IncludeSource=true --no-build
          done

      - name: Pack fixtures (GitHub only)
        run: |
          dotnet pack ./test/Stella.Ergosfare.Test.Fixtures/Stella.Ergosfare.Test.Fixtures.csproj \
            -c Release -o ./nupkg-github /p:Version=${{ env.VERSION }} \
            /p:IncludeSymbols=true /p:IncludeSource=true --no-build

      - name: Push packages to GitHub Packages
        run: |
          for pkg in ./nupkg-github/*.nupkg; do
            dotnet nuget push "$pkg" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --skip-duplicate
          done

      - name: Create GitHub Release (with pkg attachments)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          files: ./nupkg-github/*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
