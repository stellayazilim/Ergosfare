name: GitHubPackagesRelease

on:
  push:
    tags:
      - '*'  # Trigger on any tag, e.g., v0.1.0e
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        default: 'main'
      tag:
        description: 'Tag name for release (must include e)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      # 2️⃣ Setup .NET
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      # 3️⃣ Restore & Build
      - run: dotnet restore ./Stella.Ergosfare.sln
      - run: dotnet build ./Stella.Ergosfare.sln -c Release

      # 4️⃣ Set NuGet version
      - name: Set NuGet version
        id: set_version
        run: |
          # Determine tag
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          
          # Strip leading 'v'
          BASE_VERSION=${TAG_NAME#v}
          
          # Convert *.*.*e to *.*.*-e
          if [[ "$BASE_VERSION" == *e ]]; then
            VERSION="${BASE_VERSION%e}-e"
          else
            VERSION="$BASE_VERSION"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Tag: $TAG_NAME"
          echo "NuGet version: $VERSION"

      # 5️⃣ Pack source projects
      - name: Pack source projects
        run: |
          for proj in \
            ./src/Ergosfare/Ergosfare.csproj \
            ./src/Ergosfare.Contracts/Ergosfare.Contracts.csproj \
            ./src/Ergosfare.Context/Ergosfare.Context.csproj \
            ./src/Ergosfare.Core/Ergosfare.Core.csproj \
            ./src/Ergosfare.Core.Abstractions/Ergosfare.Core.Abstractions.csproj \
            ./src/Ergosfare.Core.Extensions.MicrosoftDependencyInjection/Ergosfare.Core.Extensions.MicrosoftDependencyInjection.csproj \
            ./src/Ergosfare.Queries/Ergosfare.Queries.csproj \
            ./src/Ergosfare.Queries.Abstractions/Ergosfare.Queries.Abstractions.csproj \
            ./src/Ergosfare.Queries.Extensions.MicrosoftDependencyInjection/Ergosfare.Queries.Extensions.MicrosoftDependencyInjection.csproj \
            ./src/Ergosfare.Commands/Ergosfare.Commands.csproj \
            ./src/Ergosfare.Commands.Abstractions/Ergosfare.Commands.Abstractions.csproj \
            ./src/Ergosfare.Commands.Extensions.MicrosoftDependencyInjection/Ergosfare.Commands.Extensions.MicrosoftDependencyInjection.csproj \
            ./src/Ergosfare.Events/Ergosfare.Events.csproj \
            ./src/Ergosfare.Events.Abstractions/Ergosfare.Events.Abstractions.csproj \
            ./src/Ergosfare.Events.Extensions.MicrosoftDependencyInjection/Ergosfare.Events.Extensions.MicrosoftDependencyInjection.csproj
          do
            dotnet pack $proj -c Release -o ./nupkg-github /p:Version=${{ env.VERSION }} /p:IncludeSymbols=true /p:IncludeSource=true --no-build
          done

      # 6️⃣ Push packages to GitHub Packages
      - name: Push packages to GitHub Packages
        run: |
          for pkg in ./nupkg-github/*.nupkg; do
            dotnet nuget push "$pkg" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --skip-duplicate
          done

      # 7️⃣ Create GitHub Release and attach packages
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          files: ./nupkg-github/*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
