name: NugetPackagesRelease
permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'    # Tüm v ile başlayan tagler
  workflow_dispatch:
    inputs:
      branch:
        description: 'Release source branch'
        required: true
        default: 'main'
      tag:
        description: 'Version tag (must start with v)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Determine branch
        id: resolve_branch
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_ENV
          else
            echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          fi

      - uses: actions/checkout@v3
        with:
          ref: ${{ env.branch }}

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Set version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi

          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Resolved version: $VERSION"

      - name: Validate release type
        run: |
          if [[ "${{ env.branch }}" == "main" ]] && [[ "$VERSION" == *-* ]]; then
            echo "❌ RC tag from main branch is not allowed" && exit 1
          fi
          if [[ "${{ env.branch }}" =~ rc[0-9]+ ]] && [[ "$VERSION" != *-* ]]; then
            echo "❌ Stable tag from RC branch is not allowed" && exit 1
          fi
          echo "✔ Release validation passed"

      - name: Restore
        run: dotnet restore ./Stella.Ergosfare.sln

      - name: Build
        run: dotnet build ./Stella.Ergosfare.sln -c Release

      - name: Pack source libraries
        run: |
          projects=(
            ./src/Ergosfare/Ergosfare.csproj
            ./src/Ergosfare.Contracts/Ergosfare.Contracts.csproj
            ./src/Ergosfare.Core/Ergosfare.Core.csproj
            ./src/Ergosfare.Core.Abstractions/Ergosfare.Core.Abstractions.csproj
            ./src/Ergosfare.Core.Extensions.MicrosoftDependencyInjection/Ergosfare.Core.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Ergosfare.Queries/Ergosfare.Queries.csproj
            ./src/Ergosfare.Queries.Abstractions/Ergosfare.Queries.Abstractions.csproj
            ./src/Ergosfare.Queries.Extensions.MicrosoftDependencyInjection/Ergosfare.Queries.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Ergosfare.Commands/Ergosfare.Commands.csproj
            ./src/Ergosfare.Commands.Abstractions/Ergosfare.Commands.Abstractions.csproj
            ./src/Ergosfare.Commands.Extensions.MicrosoftDependencyInjection/Ergosfare.Commands.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Ergosfare.Events/Ergosfare.Events.csproj
            ./src/Ergosfare.Events.Abstractions/Ergosfare.Events.Abstractions.csproj
            ./src/Ergosfare.Events.Extensions.MicrosoftDependencyInjection/Ergosfare.Events.Extensions.MicrosoftDependencyInjection.csproj
          )

          for proj in "${projects[@]}"; do
            echo "Packing $proj"
            dotnet pack "$proj" -c Release -o ./nupkg-release /p:Version=${{ env.VERSION }} --no-build
          done
      
      
      - name: Pack test fixtures (only GitHub, not NuGet)
        run: |
          dotnet pack ./test/Ergosfare.Test.Fixtures/Ergosfare.Test.Fixtures.csproj \
            -c Release -o ./nupkg-github /p:Version=${{ env.VERSION }} \
            /p:IncludeSymbols=true /p:IncludeSource=true --no-build

      - name: Push packages to NuGet (only stable)
        if: ${{ !contains(env.VERSION, '-') }}
        run: |
          for pkg in ./nupkg-release/*.nupkg; do
            dotnet nuget push "$pkg" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload NuGet packages
        uses: softprops/action-gh-release@v1
        with:
          files: ./nupkg-release/*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload fixture packages (always)
        uses: softprops/action-gh-release@v1
        with:
          files: ./nupkg-github/*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
