name: NugetPackagesRelease
permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'    # Tüm v ile başlayan tagler
  workflow_dispatch:
    inputs:
      branch:
        description: 'Release source branch'
        required: true
        default: 'main'
      tag:
        description: 'Version tag (must start with v)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: [9.0.x, 10.0.x]   # .NET 9 ve 10
    steps:
      - name: Determine branch
        id: resolve_branch
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_ENV
          else
            echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - uses: actions/checkout@v3
        with:
          ref: ${{ env.branch }}

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Set version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi

          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Resolved version: $VERSION"

      - name: Validate release type
        run: |
          if [[ "${{ env.branch }}" == "main" ]] && [[ "$VERSION" == *-* ]]; then
            echo "❌ RC tag from main branch is not allowed" && exit 1
          fi
          if [[ "${{ env.branch }}" =~ rc[0-9]+ ]] && [[ "$VERSION" != *-* ]]; then
            echo "❌ Stable tag from RC branch is not allowed" && exit 1
          fi
          echo "✔ Release validation passed"

      - name: Restore
        run: dotnet restore ./Stella.Ergosfare.slnx

      - name: Build
        run: dotnet build ./Stella.Ergosfare.slnx -c Release

      - name: Pack source libraries
        run: |
          projects=(
            ./src/Stella.Ergosfare/Stella.Ergosfare.csproj
            ./src/Stella.Ergosfare.Contracts/Stella.Ergosfare.Contracts.csproj
            ./src/Stella.Ergosfare.Core/Stella.Ergosfare.Core.csproj
            ./src/Stella.Ergosfare.Core.Abstractions/Stella.Ergosfare.Core.Abstractions.csproj
            ./src/Stella.Ergosfare.Core.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Core.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Stella.Ergosfare.Queries/Stella.Ergosfare.Queries.csproj
            ./src/Stella.Ergosfare.Queries.Abstractions/Stella.Ergosfare.Queries.Abstractions.csproj
            ./src/Stella.Ergosfare.Queries.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Queries.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Stella.Ergosfare.Commands/Stella.Ergosfare.Commands.csproj
            ./src/Stella.Ergosfare.Commands.Abstractions/Stella.Ergosfare.Commands.Abstractions.csproj
            ./src/Stella.Ergosfare.Commands.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Commands.Extensions.MicrosoftDependencyInjection.csproj
            ./src/Stella.Ergosfare.Events/Stella.Ergosfare.Events.csproj
            ./src/Stella.Ergosfare.Events.Abstractions/Stella.Ergosfare.Events.Abstractions.csproj
            ./src/Stella.Ergosfare.Events.Extensions.MicrosoftDependencyInjection/Stella.Ergosfare.Events.Extensions.MicrosoftDependencyInjection.csproj
          )

          for proj in "${projects[@]}"; do
            echo "Packing $proj"
            dotnet pack "$proj" -c Release -o ./nupkg-release /p:Version=${{ env.VERSION }} --no-build
          done

      - name: Authenticate with NuGet
        uses: NuGet/setup-nuget@v1
        with:
          nuget-api-key: ${{ secrets.NUGET_API_KEY }}

      - name: Push packages to NuGet (only stable)
        if: ${{ !contains(env.VERSION, '-') }}
        run: |
          for pkg in ./nupkg-release/*.nupkg; do
            dotnet nuget push "$pkg" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

      - name: Pack test fixtures (GitHub only)
        run: |
          dotnet pack ./test/Stella.Ergosfare.Test.Fixtures/Stella.Ergosfare.Test.Fixtures.csproj \
            -c Release -o ./nupkg-github /p:Version=${{ env.VERSION }} \
            /p:IncludeSymbols=true /p:IncludeSource=true --no-build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload test fixtures (optional)
        if: always()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: ./nupkg-github/*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
